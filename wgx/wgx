#!/usr/bin/env bash
set -euo pipefail

# wgx <kommando> [args...]
# WGX_TARGET_ROOT: optional, Root des Ziel-Repos (Default: $PWD)

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &>/dev/null && pwd)
CMD_DIR="$SCRIPT_DIR/cmd"
LIB_DIR="$SCRIPT_DIR/lib"

# shellcheck source=lib/logging.bash
source "$LIB_DIR/logging.bash"

list_commands() {
  log_info "Verfügbare wgx-Kommandos:"
  for cmd_path in "$CMD_DIR"/*; do
    [[ -x "$cmd_path" ]] || continue
    echo "  - $(basename "$cmd_path")"
  done
}

main() {
  if [[ $# -eq 0 ]]; then
    log_warn "Kein Befehl angegeben."
    list_commands
    exit 1
  fi

  local command="$1"; shift || true
  local cmd_path="$CMD_DIR/$command"

  if [[ ! -f "$cmd_path" ]]; then
    log_error "Unbekanntes Kommando: '$command'"
    list_commands
    exit 1
  fi

  if [[ ! -x "$cmd_path" ]]; then
    log_error "Kommando '$command' ist nicht ausführbar."
    exit 1
  fi

  export WGX_TARGET_ROOT="${WGX_TARGET_ROOT:-$PWD}"
  exec "$cmd_path" "$@"
}

main "$@"
